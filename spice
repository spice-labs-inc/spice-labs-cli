#!/usr/bin/env bash
set -euo pipefail

SPICE_LABS_CLI_JAR="${SPICE_LABS_CLI_JAR:-/opt/spice-labs-cli/spice-labs-cli.jar}"

if [ "${SPICE_LABS_CLI_USE_JVM:-0}" = "1" ]; then
  [ -f "$SPICE_LABS_CLI_JAR" ] || { echo "Missing: $SPICE_LABS_CLI_JAR"; exit 1; }
  exec java -jar "$SPICE_LABS_CLI_JAR" "$@"
else
  IMAGE="${SPICE_IMAGE:-spicelabs/spice-labs-cli}"
  TAG="${SPICE_IMAGE_TAG:-latest}"

  if [ "${SPICE_LABS_CLI_SKIP_PULL:-0}" != "1" ]; then
    docker pull "${IMAGE}:${TAG}" || echo "⚠️  Failed to pull ${IMAGE}:${TAG}, using local copy if available"
  fi

  exec docker run --rm \
    -v "$PWD":/mnt/input \
    -v "$PWD":/mnt/output \
    -e SPICE_PASS \
    "${IMAGE}:${TAG}" \
    "$@"
fi
