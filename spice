#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]}"
LOCAL_HASH=$(sha256sum "$SCRIPT_PATH" | awk '{print $1}')

REMOTE_HASH=$(
  curl -fsSL https://api.github.com/repos/spice-labs-inc/spice-labs-cli/releases/latest \
    | awk '
      BEGIN { found_spice = 0 }
      /"name":[[:space:]]*"spice"/ { found_spice = 1 }
      found_spice && /"digest":[[:space:]]*"sha256:/ {
        gsub(/.*"digest":[[:space:]]*"sha256:/, "")
        gsub(/".*/, "")
        print
        exit(0)
      }'
) || true # on Ubuntu, the exit(0) sometimes propagates... this is a no-op that catches the exit and doesn't allow it to shut down the script

if [[ -n "$REMOTE_HASH" && "$LOCAL_HASH" != "$REMOTE_HASH" ]]; then
  echo "‚ö†Ô∏è  A newer version of this script is available. Run:"
  echo "    curl -sSfL https://install.spicelabs.io | bash"
fi

SPICE_LABS_CLI_JAR="${SPICE_LABS_CLI_JAR:-/opt/spice-labs-cli/spice-labs-cli.jar}"

# portable abs path function
abs_path() {
  local path="$1"
  [[ "$path" == ~* ]] && path="${path/#\~/$HOME}"
  if [ -d "$path" ]; then
    (cd "$path" && pwd)
  else
    (cd "$(dirname "$path")" && echo "$(pwd)/$(basename "$path")")
  fi
}

if [ "${SPICE_LABS_CLI_USE_JVM:-0}" = "1" ]; then
  [ -f "$SPICE_LABS_CLI_JAR" ] || { echo "Missing: $SPICE_LABS_CLI_JAR"; exit 1; }
  JVM_ARGS="${SPICE_LABS_JVM_ARGS:--XX:MaxRAMPercentage=75}"
  # shellcheck disable=SC2086
  exec java $JVM_ARGS -jar "$SPICE_LABS_CLI_JAR" "$@"
else
  # Check if docker is installed
  if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker is not installed or not in PATH"
    echo "   Please install Docker: https://docs.docker.com/get-docker/"
    exit 1
  fi

  IMAGE="${SPICE_IMAGE:-spicelabs/spice-labs-cli}"
  TAG="${SPICE_IMAGE_TAG:-latest}"

  INPUT_DIR=""
  OUTPUT_DIR=""
  MODIFIED_ARGS=()

  prev=""
  for arg in "$@"; do
    if [[ "$arg" == --input=* ]]; then
      INPUT_DIR="${arg#--input=}"
      MODIFIED_ARGS+=("--input" "/mnt/input")
    elif [[ "$arg" == --output=* ]]; then
      OUTPUT_DIR="${arg#--output=}"
      MODIFIED_ARGS+=("--output" "/mnt/output")
    elif [[ "$prev" == "--input" ]]; then
      INPUT_DIR="$arg"
      MODIFIED_ARGS+=("/mnt/input")
      prev=""
    elif [[ "$prev" == "--output" ]]; then
      OUTPUT_DIR="$arg"
      MODIFIED_ARGS+=("/mnt/output")
      prev=""
    elif [[ "$arg" == "--input" || "$arg" == "--output" ]]; then
      MODIFIED_ARGS+=("$arg")
      prev="$arg"
    else
      if [[ "$arg" == -V ]]; then
        echo "script version ${LOCAL_HASH}"
      fi
      MODIFIED_ARGS+=("$arg")
      prev=""
    fi
  done

  if [ -z "$INPUT_DIR" ]; then
    INPUT_DIR="."
    MODIFIED_ARGS+=("--input" "/mnt/input")
  fi

  VOLUMES=("-v" "$(abs_path "$INPUT_DIR"):/mnt/input")
  [ -n "$OUTPUT_DIR" ] && VOLUMES+=("-v" "$(abs_path "$OUTPUT_DIR"):/mnt/output")

  # Check if we're in debug/trace mode
  DEBUG_MODE=0
  for arg in "$@"; do
    arg_lower=$(echo "$arg" | tr '[:upper:]' '[:lower:]')
    if [[ "$arg_lower" == --log-level=debug || "$arg_lower" == --log-level=trace || "$arg_lower" == --log-level=all ]]; then
      DEBUG_MODE=1
      break
    fi
  done

  if [ "${SPICE_LABS_CLI_SKIP_PULL:-0}" != "1" ]; then
    if [ "$DEBUG_MODE" = "1" ]; then
      echo "üì¶ Checking for updates to Spice Labs Surveyor CLI..."
      docker pull "${IMAGE}:${TAG}" || echo "‚ö†Ô∏è  Failed to pull ${IMAGE}:${TAG}, using local copy if available"
    else
      echo "üì¶ Checking for updates to Spice Labs Surveyor CLI..."
      docker pull --quiet "${IMAGE}:${TAG}" > /dev/null 2>&1 || echo "‚ö†Ô∏è  Failed to pull ${IMAGE}:${TAG}, using local copy if available"
    fi
  fi

  # Use --pull=never if skip pull is set, otherwise use default pull behavior
  PULL_FLAG=""
  if [ "${SPICE_LABS_CLI_SKIP_PULL:-0}" = "1" ]; then
    PULL_FLAG="--pull=never"
  fi

  exec docker run --rm \
    --user $(id -u):$(id -g) \
    ${PULL_FLAG:+$PULL_FLAG} \
    ${SPICE_DOCKER_FLAGS:+$SPICE_DOCKER_FLAGS} \
    ${VOLUMES+"${VOLUMES[@]}"} \
    -e SPICE_PASS \
    ${SPICE_LABS_JVM_ARGS:+-e SPICE_LABS_JVM_ARGS} \
    "${IMAGE}:${TAG}" \
    "${MODIFIED_ARGS[@]}"
fi
