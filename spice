#!/usr/bin/env bash
set -euo pipefail

WRAPPER_VERSION="0.2.11"
LATEST_VERSION=$(curl -fsSL https://api.github.com/repos/spice-labs-inc/spice-labs-cli/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' || echo "")

if [[ "$LATEST_VERSION" != "$WRAPPER_VERSION" && "$LATEST_VERSION" != "" ]]; then
  echo "⚠️  A newer spice script ($LATEST_VERSION) is available. Run:"
  echo "    curl -sSf https://install.spicelabs.io | bash"
fi

SPICE_LABS_CLI_JAR="${SPICE_LABS_CLI_JAR:-/opt/spice-labs-cli/spice-labs-cli.jar}"

# portable abs path function
abs_path() {
  cd "$1" 2>/dev/null && pwd
}

if [ "${SPICE_LABS_CLI_USE_JVM:-0}" = "1" ]; then
  [ -f "$SPICE_LABS_CLI_JAR" ] || { echo "Missing: $SPICE_LABS_CLI_JAR"; exit 1; }
  JVM_ARGS="${SPICE_LABS_JVM_ARGS:--XX:MaxRAMPercentage=75}"
  # shellcheck disable=SC2086
  exec java $JVM_ARGS -jar "$SPICE_LABS_CLI_JAR" "$@"
else
  IMAGE="${SPICE_IMAGE:-spicelabs/spice-labs-cli}"
  TAG="${SPICE_IMAGE_TAG:-latest}"

  INPUT_DIR=""
  OUTPUT_DIR=""
  MODIFIED_ARGS=()

  for arg in "$@"; do
    case "$arg" in
      --input=*)
        INPUT_DIR="${arg#--input=}"
        MODIFIED_ARGS+=("--input" "/mnt/input")
        ;;
      --output=*)
        OUTPUT_DIR="${arg#--output=}"
        MODIFIED_ARGS+=("--output" "/mnt/output")
        ;;
      --input|--output)
        prev="$arg"
        ;;
      *)
        if [ "${prev:-}" = "--input" ]; then
          INPUT_DIR="$arg"
          MODIFIED_ARGS+=("/mnt/input")
          unset prev
        elif [ "${prev:-}" = "--output" ]; then
          OUTPUT_DIR="$arg"
          MODIFIED_ARGS+=("/mnt/output")
          unset prev
        else
          MODIFIED_ARGS+=("$arg")
        fi
        ;;
    esac
  done

  if [ -z "$INPUT_DIR" ]; then
    INPUT_DIR="."
    MODIFIED_ARGS+=("--input" "/mnt/input")
  fi

  VOLUMES=("-v" "$(abs_path "$INPUT_DIR"):/mnt/input")
  [ -n "$OUTPUT_DIR" ] && VOLUMES+=("-v" "$(abs_path "$OUTPUT_DIR"):/mnt/output")

  if [ "${SPICE_LABS_CLI_SKIP_PULL:-0}" != "1" ]; then
    docker pull "${IMAGE}:${TAG}" || echo "⚠️  Failed to pull ${IMAGE}:${TAG}, using local copy if available"
  fi

  exec docker run --rm \
    ${VOLUMES+"${VOLUMES[@]}"} \
    -e SPICE_PASS \
    ${SPICE_LABS_JVM_ARGS:+-e SPICE_LABS_JVM_ARGS} \
    "${IMAGE}:${TAG}" \
    "${MODIFIED_ARGS[@]}"
fi
